# ╭───────────────────────────────────────────────────────────────────────────╮
# │                               REQUIREMENTS                                │
# ╰───────────────────────────────────────────────────────────────────────────╯
#
# Make sure the following SECRET variables are set to access your server.
# SSH_PASS        = Password to your server to upload video to.  
# SSH_USER        = Username to your server to upload video to.
# RCLONE_CONF_B64 = Configuration of rCLone to allow access to Google Drive.

name: 🎢 Full Video Constructor


on:
    # Run Via a webhook only
    workflow_dispatch:
      inputs:
        config_b64:
          description: 'Base64 configuration for Video Constructor'     
          required: true


jobs:

    # ╭──────────────────────────────────────────────────────────────────────────╮
    # │   This is all one job. The reason is because moving large video files    │░
    # │       across jobs using artifacts takes time and space. Therefore        │░
    # │        keeping the whole process on a single job increases speed.        │░
    # ╰░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
    video_constructor:
        runs-on: ubuntu-latest

        steps:



            # ╭───────────────────────────────────────────────────────╮
            # │             GET CONTENTS OF CURRENT REPO              │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎛️ SETUP - Checkout Repo
              uses: actions/checkout@v3



            # ╭───────────────────────────────────────────────────────╮
            # │      DECODE THE BASE64 CONFIGS READY TO BE USED       │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎛️ SETUP - Base64 decode Configs
              run: |
                echo "${{ secrets.RCLONE_CONF_B64 }}" | base64 --decode > rclone.conf
                echo "${{ github.event.inputs.config_b64 }}" | base64 --decode > config.json



            # ╭───────────────────────────────────────────────────────╮
            # │             JSON TO ENVIRONMENT VARIABLES             │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎛️ SETUP - JSON to Environment Variables
              run: |
                ./scripts/env/json_to_env.sh 

            - name: 🎛️ SETUP - Environment Variables Remove Quotes
              run: |
                VC_OVERLAY_TEMPLATE=${{ env.VC_OVERLAY_TEMPLATE }}
                echo "VC_OVERLAY_TEMPLATE=${VC_OVERLAY_TEMPLATE//\"/}" >> $GITHUB_ENV
                env


            # ╭───────────────────────────────────────────────────────╮
            # │             GENERATE A UNIQUE IDENTIFIER              │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎛️ SETUP - Generate UUID
              run: |
                  echo "UUID=$(openssl rand -hex 6)" >> $GITHUB_ENV



            # ╭──────────────────────────────────────────────────────────────────────────╮
            # │                                                                          │░
            # │                                                                          │░
            # │                              YOUTUBE SEARCH                              │░
            # │                                                                          │░
            # │                                                                          │░
            # ╰░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░



            # ╭───────────────────────────────────────────────────────╮
            # │                    INSTALL YT-DLP                     │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🔎 SEARCH - Install yt-dlp
              run: sudo pip install yt-dlp



            # ╭───────────────────────────────────────────────────────╮
            # │                     URL SEARCH                        │
            # ╰───────────────────────────────────────────────────────╯
            #
            # OUTPUTS = videoid_results.json
            #
            - name: 🔎 SEARCH - Do YouTube URL Search
              if: ${{ env.VC_SEARCH_RUN && env.VC_SEARCH_QUERYURL }}
              run: |
                  ./scripts/search/search_url.sh "${{ env.VC_SEARCH_QUERYURL }}" ${{ env.VC_SEARCH_COUNT }}


                  
            # ╭───────────────────────────────────────────────────────╮
            # │                    KEYWORDS SEARCH                    │
            # ╰───────────────────────────────────────────────────────╯
            #
            # OUTPUTS = videoid_results.json
            #
            - name: 🔎 SEARCH - Do YouTube KEYWORD Search
              if: ${{ env.VC_SEARCH_RUN && env.VC_SEARCH_KEYWORD }}
              run: |
                  ./scripts/search/search_keyword.sh "${{ env.VC_SEARCH_KEYWORD }}" ${{ env.VC_SEARCH_COUNT }}

                


            # ╭──────────────────────────────────────────────────────────────────────────╮
            # │                                                                          │░
            # │                                                                          │░
            # │                                 SNIPPETS                                 │░
            # │                                                                          │░
            # │                                                                          │░
            # ╰░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░



            # ╭───────────────────────────────────────────────────────╮
            # │                     INSTALL MPV                       │
            # ╰───────────────────────────────────────────────────────╯
            - name: 📹 DOWNLOAD - Install mpv
              if: ${{ env.VC_DOWNLOAD_RUN }}
              run: |
                sudo apt-get update
                sudo apt-get install --no-install-recommends mpv
            

            # ╭───────────────────────────────────────────────────────╮
            # │                  RUN THE DOWNLOADER                   │
            # ╰───────────────────────────────────────────────────────╯
            ##
            ## INPUT = videoid_results.json
            ## OUTPUT = MP4 Video files
            ##
            - name: 📹 DOWNLOAD - Run Snippet Downloader
              if: ${{ env.VC_DOWNLOAD_RUN }}
              run: |
                cat videoid_results.json | jq -r -c '.results[] | .video' | while read -r video; do
                    video_id=$(echo "$video" | sed 's/^.*=//' | cut -d'&' -f1)
                    echo "Download snippets for $video_id"
                    command="./scripts/snippets/yt_snippets.sh --videoid $video_id --count ${{ env.VC_DOWNLOAD_COUNT }} --duration ${{ env.VC_DOWNLOAD_DURATION }}"
                    if [ -n "${{ env.VC_DOWNLOAD_TIMESTAMPS }}" ]; then
                        command+=" --timestamps ${{ env.VC_DOWNLOAD_TIMESTAMPS }}"
                    fi        
                    eval "$command"
                done
                mkdir videos
                mv *.mp4 ./videos
                ls -la
                ls -la ./videos 
                    


            # ╭──────────────────────────────────────────────────────────────────────────╮
            # │                                                                          │░
            # │                                                                          │░
            # │                                 OVERLAY                                  │░
            # │                                                                          │░
            # │                                                                          │░
            # ╰░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░



            # ╭───────────────────────────────────────────────────────╮
            # │                      Setup Node                       │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Set up Node.js
              if: ${{ env.VC_OVERLAY_RUN }}
              uses: actions/setup-node@v2
              with:
                node-version: '22'



            # ╭───────────────────────────────────────────────────────╮
            # │                  Install PHP Server                   │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Set up PHP
              if: ${{ env.VC_OVERLAY_RUN }}
              uses: shivammathur/setup-php@v2
              with:
                php-version: '8.0'



            # ╭───────────────────────────────────────────────────────╮
            # │                    Install FFMPEG                     │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Install FFMPEG
              if: ${{ env.VC_OVERLAY_RUN }}
              uses: FedericoCarboni/setup-ffmpeg@v2
 
            - name: 🎨 OVERLAY - Link FFMPEG to /usr/local/bin
              if: ${{ env.VC_OVERLAY_RUN }}
              run: |
                cd /usr/local/bin
                env
                ln -s /opt/hostedtoolcache/ffmpeg/*/x64/ffmpeg ./ffmpeg
                ln -s /opt/hostedtoolcache/ffmpeg/*/x64/ffprobe ./ffprobe  



            # ╭───────────────────────────────────────────────────────╮
            # │                   Setup the Overlay                   │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Setup Overlay
              if: ${{ env.VC_OVERLAY_RUN }}
              run: | 
                unzip ${GITHUB_WORKSPACE}/overlays/${{ env.VC_OVERLAY_TEMPLATE }}/template.zip -d ${GITHUB_WORKSPACE}/overlays/${{ env.VC_OVERLAY_TEMPLATE }}/



            # ╭───────────────────────────────────────────────────────╮
            # │             Optional setup of inputs.json             │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Setup Inputs.json
              if: ${{ env.VC_OVERLAY_RUN }}
              run: |   
                cat config.json | jq -r '.overlay.inputs' > ${GITHUB_WORKSPACE}/overlays/${{ env.VC_OVERLAY_TEMPLATE }}/inputs.json
                
                
            
            # ╭───────────────────────────────────────────────────────╮
            # │                   Start PHP Server                    │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Start PHP server in background
              if: ${{ env.VC_OVERLAY_RUN }}
              run: |
                php -S 0.0.0.0:8080 -t ./overlays/${{ env.VC_OVERLAY_TEMPLATE }}/ &
        


            # ╭───────────────────────────────────────────────────────╮
            # │         Install Timecut with latest puppeteer         │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Setup Timecut
              if: ${{ env.VC_OVERLAY_RUN }}
              run: |
                npm install
                rm -Rf ${GITHUB_WORKSPACE}/node_modules/puppeteer
                cd ${GITHUB_WORKSPACE}/node_modules/timesnap/
                sed -i 's/"puppeteer": "\^2.1.1"/"puppeteer": "\^22.10.0"/' package.json
                npm install
                cd ${GITHUB_WORKSPACE}
                rm package-lock.json
                npm install
                cat ${GITHUB_WORKSPACE}/node_modules/puppeteer/package.json



            # ╭───────────────────────────────────────────────────────╮
            # │               Ensure website is running               │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Test Site Running
              if: ${{ env.VC_OVERLAY_RUN }}
              run: |
                curl "http://localhost:8080"



            # ╭───────────────────────────────────────────────────────╮
            # │             Use Timecut to capture Video              │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Capture Video
              continue-on-error: true
              if: ${{ env.VC_OVERLAY_RUN }}
              run: |
                node ${GITHUB_WORKSPACE}/node_modules/timecut/cli.js "http://localhost:8080" --selector=${{ env.VC_OVERLAY_TIMECUT_TARGET }} --viewport=${{ env.VC_OVERLAY_TIMECUT_VIEWPORT }} ${{ env.VC_OVERLAY_TIMECUT_SETTINGS }} --transparent-background --output-options="-c:v png" --pix-fmt=rgba --output=overlay_video.mov --launch-arguments="--no-sandbox --disable-setuid-sandbox --allow-file-access-from-files"
                mkdir overlay
                mv overlay_video.mov ./overlay
                ls -la
                ls -la ./overlay
                




            # ╭───────────────────────────────────────────────────────╮
            # │                         HTTP                          │
            # ╰───────────────────────────────────────────────────────╯
            - uses: dsmirc/ngrok-tunnel-action@cd
              with:
                timeout: 1h
                port: 8080
                ngrok_authtoken: ${{ secrets.NGROK_AUTHTOKEN }}
                tunnel_type: http
                save_url_to_filename: tunnelURL.md

            # ╭───────────────────────────────────────────────────────╮
            # │                          SSH                          │
            # ╰───────────────────────────────────────────────────────╯
            - name: Setup upterm session
              uses: lhotari/action-upterm@v1






            # ╭──────────────────────────────────────────────────────────────────────────╮
            # │                                                                          │░
            # │                                                                          │░
            # │                                SCRIPTFLOW                                │░
            # │                                                                          │░
            # │                                                                          │░
            # ╰░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░



            # ╭───────────────────────────────────────────────────────╮
            # │               INSTALL FFMPEG SCRIPTFLOW               │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎥 VIDEO - Install Scriptflow
              if: ${{ env.VC_VIDEO_RUN }}
              run: |
                  sudo git clone https://github.com/IORoot/ffmpeg__bash-scripts.git /tmp/scriptflow
                  sudo mv /tmp/scriptflow/*.sh /usr/local/bin
                  sudo chmod +x /usr/local/bin/*



            # ╭───────────────────────────────────────────────────────╮
            # │  Run /usr/local/bin/scriptflow.sh with the config.json  │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎥 VIDEO - Run ScriptFlow
              if: ${{ env.VC_VIDEO_RUN }}
              run: |
                cat config.json | jq -r '.video.config' > ${GITHUB_WORKSPACE}/video_config.json
                export PATH=$PATH:$(pwd)
                scriptflow.sh --config $(realpath ./video_config.json) -t

                  
            # ╭──────────────────────────────────────────────────────────────────────────╮
            # │                                                                          │░
            # │                                                                          │░
            # │                                 OUTPUTS                                  │░
            # │                                                                          │░
            # │                                                                          │░
            # ╰░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░



            # ╭───────────────────────────────────────────────────────╮
            # │                     GOOGLE DRIVE                      │
            # ╰───────────────────────────────────────────────────────╯
            - name: 📬 OUTPUTS - Install rClone
              if: ${{ env.VC_OUTPUTS_GDRIVE_RUN }}
              run: |
                sudo apt install rclone

            - name: 📬 OUTPUTS - rClone copy
              if: ${{ env.VC_OUTPUTS_GDRIVE_RUN }}
              run: |
                  rclone copy ./output.mp4 GDrive:${{ env.VC_OUTPUTS_GDRIVE_FOLDER }}/${UUID}/ --config rclone.conf 
    
            

            # ╭───────────────────────────────────────────────────────╮
            # │                        WEBHOOK                        │
            # ╰───────────────────────────────────────────────────────╯
            - name: Trigger Return Webhook
              if: ${{ env.VC_OUTPUTS_WEBHOOK_RUN }}
      
              run: |
                curl -X POST \
                  -H "Content-Type: text/plain" \
                  -d "" \
                  ${{ env.VC_OUTPUTS_WEBHOOK_URL }}



            # ╭───────────────────────────────────────────────────────╮
            # │                        SERVER                         │
            # ╰───────────────────────────────────────────────────────╯
            - name: install dependencies
              if: ${{ env.VC_OUTPUTS_SSH_RUN }}
              run: |
                sudo apt-get install --no-install-recommends ssh sshpass

            - name: Copy Video to Server
              if: ${{ env.VC_OUTPUTS_SSH_RUN }}
              run: |
                  mkdir ~/.ssh
                  ssh-keyscan -H ${{ env.VC_OUTPUTS_SSH_SERVER }} >> ~/.ssh/known_hosts
                  TARGET_DIR="${{ env.VC_OUTPUTS_SSH_FOLDER }}/${UUID}/"
                  sshpass -p '${{ secrets.SSH_PASS }}' ssh -v -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SSH_USER }}@${{ env.VC_OUTPUTS_SSH_SERVER }} "mkdir -p ${TARGET_DIR}"
                  cd ./${UUID}_processed_video
                  sshpass -p '${{ secrets.SSH_PASS }}' scp -v -p -r -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null * ${{ secrets.SSH_USER }}@${{ env.VC_OUTPUTS_SSH_SERVER }}:${TARGET_DIR}
      


            # ╭───────────────────────────────────────────────────────╮
            # │                   CREATE A RELEASE                    │
            # ╰───────────────────────────────────────────────────────╯
            - name: Create a Release
              if: ${{ env.VC_OUTPUTS_RELEASE_RUN }}
              run: |
                  create_release.sh \
                  --target ${{ env.VC_OUTPUTS_RELEASE_API_URL }} \
                  --token ${{ env.VC_OUTPUTS_RELEASE_API_TOKEN }} \
                  --schedule "${{ env.VC_OUTPUTS_RELEASE_SCHEDULE  }}" \
                  --title "${{ env.VC_OUTPUTS_RELEASE_ACTION }} - ${UUID}" \
                  --content "" \
                  --gdrive ${GDRIVE_FILE_ID} \
                  --video ${{ env.VC_OUTPUTS_SSH_SERVER }}/${{ env.VC_OUTPUTS_SSH_FOLDER }}/${UUID}/video.mp4 \
                  --thumbnail ${{ env.VC_OUTPUTS_SSH_SERVER }}/${{ env.VC_OUTPUTS_SSH_FOLDER }}/${UUID}/thumbnail.png


            # ╭──────────────────────────────────────────────────────────────────────────╮
            # │                                                                          │░
            # │                                                                          │░
            # │                                DEBUGGERS                                 │░
            # │                                                                          │░
            # │                                                                          │░
            # ╰░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░

            # ╭───────────────────────────────────────────────────────╮
            # │                          SSH                          │
            # ╰───────────────────────────────────────────────────────╯
            # - name: Setup upterm session
            #   uses: lhotari/action-upterm@v1

            # ╭───────────────────────────────────────────────────────╮
            # │                         HTTP                          │
            # ╰───────────────────────────────────────────────────────╯
            # - uses: dsmirc/ngrok-tunnel-action@cd
            # with:
            #   timeout: 1h
            #   port: 8080
            #   ngrok_authtoken: ${{ secrets.NGROK_AUTHTOKEN }}
            #   tunnel_type: http
            #   save_url_to_filename: tunnelURL.md