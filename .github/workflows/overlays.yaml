
name: 🗾 Overlays

on:
    workflow_call:
        inputs:
            config_b64:
                type: string
                description: 'Base64 configuration for Video Constructor'     
                required: true
            template_name:
                description: 'Base64 Encoded Template Name'
                required: true
                type: string
            encoded_template:
                description: 'Base64 Encoded Template'
                required: true
                type: string



jobs:

    generate_overlay:
        runs-on: ubuntu-latest
        continue-on-error: true
        steps:

              
            # ╭───────────────────────────────────────────────────────╮
            # │             GET CONTENTS OF CURRENT REPO              │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎛️ SETUP - Checkout Repo
              uses: actions/checkout@v3


            # ╭───────────────────────────────────────────────────────╮
            # │             JSON TO ENVIRONMENT VARIABLES             │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎛️ SETUP - JSON to Environment Variables
              run: |
                # Default base64 config
                echo "${{ inputs.config_b64 }}" | base64 --decode > config.json
                ./scripts/env/json_to_env.sh 

                # TEMPLATE config
                decoded_template=$(echo "${{ inputs.encoded_template }}" | base64 --decode)
                echo "$decoded_template" > decoded_template.json
                ./scripts/env/json_to_env.sh ${GITHUB_WORKSPACE}/decoded_template.json
                env


            # ╭──────────────────────────────────────────────────────────────────────────╮
            # │                                                                          │░
            # │                                                                          │░
            # │                                 OVERLAY                                  │░
            # │                                                                          │░
            # │                                                                          │░
            # ╰░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░



            # ╭───────────────────────────────────────────────────────╮
            # │                      Setup Node                       │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Set up Node.js
              uses: actions/setup-node@v2
              with:
                node-version: '22'



            # ╭───────────────────────────────────────────────────────╮
            # │                  Install PHP Server                   │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Set up PHP
              uses: shivammathur/setup-php@v2
              with:
                php-version: '8.0' 



            # ╭───────────────────────────────────────────────────────╮
            # │                    Install FFMPEG                     │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎛️ SETUP - Install FFMPEG
              uses: FedericoCarboni/setup-ffmpeg@v2
 
            - name: 🎛️ SETUP - Link FFMPEG to /usr/local/bin
              run: |
                cd /usr/local/bin
                env
                ln -s /opt/hostedtoolcache/ffmpeg/*/x64/ffmpeg ./ffmpeg
                ln -s /opt/hostedtoolcache/ffmpeg/*/x64/ffprobe ./ffprobe 
                


            # ╭───────────────────────────────────────────────────────╮
            # │                   Setup the Overlay                   │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Setup Overlay
              run: | 
                unzip ${GITHUB_WORKSPACE}/overlays/${{ inputs.template_name }}/template.zip -d ${GITHUB_WORKSPACE}/overlays/${{ inputs.template_name }}/
                if [ -f "${GITHUB_WORKSPACE}/overlays/${{ inputs.template_name }}/lottie.json" ]; then
                  cp ${GITHUB_WORKSPACE}/overlays/${{ inputs.template_name }}/lottie.json ${GITHUB_WORKSPACE}/overlays/${{ inputs.template_name }}/public/js/lottie.json
                fi


                
            # ╭───────────────────────────────────────────────────────╮
            # │        The Slider Revolution Local Assets fix          │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Replace Remote Images for local Assets
              run: |
                ./scripts/overlay/replace_images.sh ./overlays/${{ inputs.template_name }}/assets




            # ╭───────────────────────────────────────────────────────╮
            # │             Optional setup of inputs.json             │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Setup Inputs.json
              if: ${{ env.VC_INPUTS != '' && env.VC_INPUTS != null }}
              run: |   
                cat decoded_template.json | jq -r '.inputs' > ${GITHUB_WORKSPACE}/overlays/${{ inputs.template_name }}/inputs.json
                cat ${GITHUB_WORKSPACE}/overlays/${{ inputs.template_name }}/inputs.json



            # ╭───────────────────────────────────────────────────────╮
            # │         Optional Search/Replace Lottie JSON           │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Override Lottie.json
              if: ${{ env.VC_LOTTIE_OVERRIDES != '' && env.VC_LOTTIE_OVERRIDES != null }}
              run: |   
                cat decoded_template.json | jq -r '.lottie_overrides' > ${GITHUB_WORKSPACE}/lottie_overrides.json
                cat ${GITHUB_WORKSPACE}/lottie_overrides.json
                ./scripts/overlay/lottie_overrides.sh --lottiefile ${GITHUB_WORKSPACE}/overlays/${{ inputs.template_name }}/public/js/lottie.json --overridefile ${GITHUB_WORKSPACE}/lottie_overrides.json



            # ╭───────────────────────────────────────────────────────╮
            # │                   Start PHP Server                    │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Start PHP server in background
              run: |
                php -S 0.0.0.0:8080 -t ./overlays/${{ inputs.template_name }}/ &
        


            # ╭───────────────────────────────────────────────────────╮
            # │         Install Timecut with latest puppeteer         │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Setup Timecut
              continue-on-error: true
              run: |
                npm install puppeteer@22.10.0

                cd ${GITHUB_WORKSPACE}/node_modules/timesnap/
                rm -Rf node_modules

                sed -i 's/"puppeteer": "\^2.1.1"/"puppeteer": "\^22.10.0"/' package.json
                npm install puppeteer@22.10.0

                cd ${GITHUB_WORKSPACE}



            # ╭───────────────────────────────────────────────────────╮
            # │               Ensure website is running               │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Test Site Running
              run: |
                curl "http://localhost:8080"


            # ╭───────────────────────────────────────────────────────╮
            # │             Use Timecut to capture Video              │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🎨 OVERLAY - Capture Video
              continue-on-error: true
              run: |
                node ${GITHUB_WORKSPACE}/node_modules/timecut/cli.js "http://localhost:8080" --selector="${{ env.VC_TIMECUT_SELECTOR }}" --viewport="${{ env.VC_TIMECUT_VIEWPORT }}" ${{ env.VC_TIMECUT_SETTINGS }} --transparent-background --output-options="-c:v png" --pix-fmt=rgba --output=overlay_video.mov --launch-arguments="--no-sandbox --disable-setuid-sandbox --allow-file-access-from-files"
                mkdir overlay
                cp overlay_video.mov ./overlay/overlay_${{ inputs.template_name }}.mov
                ls -la
                ls -la ./overlay



            # ╭───────────────────────────────────────────────────────╮
            # │           Upload the overlays as artifacts            │
            # ╰───────────────────────────────────────────────────────╯
            - name: 🆙 Upload file as artifact
              uses: actions/upload-artifact@v4  # Use v4
              with:
                name: overlay-${{ inputs.template_name }}
                path: ./overlay/overlay-${{ inputs.template_name }}.mov



            # # ╭───────────────────────────────────────────────────────╮
            # # │                          SSH                          │
            # # ╰───────────────────────────────────────────────────────╯
            # - name: 🪲 DEBUG - Setup upterm session
            #   uses: lhotari/action-upterm@v1

               